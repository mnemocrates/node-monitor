#!/usr/bin/env bash

############################################################
# Node Monitor Configuration (example)
#
# Copy this file to config.sh and customize values for
# your environment. This example contains no sensitive or
# system‑specific information.
############################################################

##############################
# Identity
##############################

# Logical name for this node (used in alerts and exports)
NODE_NAME="my-node"

# Short hostname (auto-detected; override if needed)
HOSTNAME_SHORT="$(hostname -s)"


##############################
# Paths to Binaries
##############################

BITCOIN_CLI="/usr/local/bin/bitcoin-cli"
BITCOIN_CONF=""  # Optional: specify full path to bitcoin.conf (leave empty for default)
LNCLI="/usr/local/bin/lncli"
SIGNAL_CLI="/usr/bin/signal-cli"
CURL_BIN="/usr/bin/curl"
NC_BIN="/usr/bin/nc"
JQ_BIN="/usr/bin/jq"   # jq is optional; scripts degrade gracefully


##############################
# LND Authentication
##############################

# Adjust these paths to match your LND installation.
LND_TLSCERT="/home/youruser/.lnd/tls.cert"
LND_MACAROON="/home/youruser/.lnd/data/chain/bitcoin/mainnet/admin.macaroon"


##############################
# Tor Configuration
##############################

TOR_SOCKS_HOST="127.0.0.1"
TOR_SOCKS_PORT=9050

# Tor‑proxied curl template
TOR_CURL="${CURL_BIN} --socks5-hostname ${TOR_SOCKS_HOST}:${TOR_SOCKS_PORT} -s --connect-timeout 10 --max-time 20"

# Tor Check Reliability Settings
# Tor can be slow and transient failures are common during circuit building
TOR_CHECK_RETRIES=3                  # Number of retry attempts for Tor checks
TOR_CHECK_RETRY_DELAY=10             # Seconds between retry attempts
TOR_CHECK_TIMEOUT=30                 # Connection timeout for Tor operations (seconds)
TOR_FAILURE_CRIT_DURATION=900        # Only escalate to CRIT after failing for this many seconds (15 min default)


##############################
# Signal Notification (optional)
##############################

SIGNAL_ENABLED=false

# Replace with your own values if using signal-cli.
SIGNAL_FROM="+15550000000"
SIGNAL_TO="+15550000000"
SIGNAL_TO_GROUP="your-signal-group-id-here"


##############################
# Email Notification (optional)
##############################

EMAIL_ENABLED=false

EMAIL_TO="you@example.com"
EMAIL_FROM="you@example.com"

SMTP_SERVER="smtp.example.com"
SMTP_PORT=587

SMTP_USERNAME="you@example.com"
SMTP_PASSWORD="your-smtp-password-or-app-password"


##############################
# ntfy Notification (recommended)
##############################

NTFY_ENABLED=true
NTFY_USE_TOR=true

# Example: https://ntfy.sh/my-node-alerts
NTFY_TOPIC="https://ntfy.sh/your-ntfy-topic-here"

# Optional bearer token for protected topics
NTFY_TOKEN=""


##############################
# Thresholds
##############################

DISK_WARN_PCT=85
DISK_CRIT_PCT=90

# Bitcoin Core Monitoring Thresholds
# ---------------------------
# RPC connectivity and performance
BITCOIN_RPC_RETRIES=3                # Number of retry attempts for RPC calls
BITCOIN_RPC_RETRY_DELAY=5            # Seconds between retry attempts
BITCOIN_RPC_LATENCY_WARN=2000        # Warn if RPC latency exceeds this (milliseconds)
BITCOIN_RPC_LATENCY_CRIT=5000        # Critical if RPC latency exceeds this (milliseconds)
BITCOIN_RPC_FAILURE_GRACE=300        # Grace period before escalating to CRIT (seconds)

# Sync status thresholds
BITCOIN_VERIFICATION_PROGRESS_WARN=0.9999  # Warn if verification progress below this

# Block height drift (vs external sources)
BITCOIN_BLOCKHEIGHT_DRIFT_WARN=2     # Warn if drift exceeds this
BITCOIN_BLOCKHEIGHT_DRIFT_CRIT=5     # Critical if drift exceeds this
BITCOIN_BLOCKHEIGHT_CHECK_RETRIES=3  # Retry attempts for external API

# Block age (time since last block)
BITCOIN_BLOCK_AGE_WARN=1200          # Warn if last block older than 20 minutes (seconds)
BITCOIN_BLOCK_AGE_CRIT=2400          # Critical if last block older than 40 minutes (seconds)

# External block height sources (comma-separated, will try in order)
BITCOIN_BLOCKHEIGHT_SOURCES="https://blockstream.info/api/blocks/tip/height,https://mempool.space/api/blocks/tip/height"
BITCOIN_BLOCKHEIGHT_USE_TOR=false    # Use Tor for external API calls

BITCOIND_MAX_LAG_WARN=2
BITCOIND_MAX_LAG_CRIT=3

# LND Monitoring Thresholds
# ---------------------------
# LND wallet/RPC connectivity
LND_RPC_RETRIES=3                    # Number of retry attempts for LND RPC calls
LND_RPC_RETRY_DELAY=5                # Seconds between retry attempts

# Peer count thresholds
LND_PEERS_WARN=3                     # Warn if fewer than this many peers
LND_PEERS_CRIT=1                     # Critical if at or below this (0 peers always critical)

# Active channel count thresholds
LND_CHANNELS_WARN=3                  # Warn if fewer active channels
LND_CHANNELS_CRIT=1                  # Critical if at or below this
LND_CHANNELS_INACTIVE_WARN=2         # Warn if this many or more channels are inactive

# Block height drift thresholds (LND vs Bitcoin Core)
LND_BLOCKHEIGHT_DRIFT_WARN=3         # Warn if drift exceeds this
LND_BLOCKHEIGHT_DRIFT_CRIT=10        # Critical if drift exceeds this

# Sync status grace periods (avoid alerts during restarts)
LND_CHAIN_SYNC_GRACE=300             # Seconds to wait before alerting on chain unsync (5 min)
LND_GRAPH_SYNC_GRACE=1800            # Seconds before warning on graph unsync (30 min)

# Electrs Monitoring Thresholds
# ---------------------------
# Connection settings
ELECTRS_HOST="127.0.0.1"
ELECTRS_PORT=50001

# Retry and timeout settings
ELECTRS_TIMEOUT=15                   # Connection timeout (seconds) - longer for heavy indexing
ELECTRS_RETRIES=3                    # Number of retry attempts
ELECTRS_RETRY_DELAY=5                # Seconds between retry attempts

# Block height drift thresholds (Electrs vs Bitcoin Core)
ELECTRS_DRIFT_WARN=3                 # Warn if drift exceeds this
ELECTRS_DRIFT_CRIT=10                # Critical if drift exceeds this

# Performance thresholds
ELECTRS_RESPONSE_TIME_WARN=5000      # Warn if response time exceeds this (milliseconds)
ELECTRS_RESPONSE_TIME_CRIT=15000     # Critical if response time exceeds this (milliseconds)

# Grace period for transient failures
ELECTRS_FAILURE_GRACE=300            # Only escalate to CRIT after failing for this many seconds (5 min)

# System Monitoring Thresholds
# ---------------------------
# Disk space monitoring
# Leave DISK_MOUNTS empty to auto-detect all mounted filesystems
# Or specify mount points as space-separated list: DISK_MOUNTS="/ /mnt/data"
DISK_MOUNTS=""                       # Auto-detect if empty
DISK_WARN_PCT=80                     # Warn if disk usage exceeds this percentage
DISK_CRIT_PCT=90                     # Critical if disk usage exceeds this percentage
DISK_INODE_WARN_PCT=80               # Warn if inode usage exceeds this percentage
DISK_INODE_CRIT_PCT=90               # Critical if inode usage exceeds this percentage

# Memory monitoring
MEMORY_WARN_PCT=85                   # Warn if RAM usage exceeds this percentage
MEMORY_CRIT_PCT=95                   # Critical if RAM usage exceeds this percentage
SWAP_WARN_PCT=50                     # Warn if swap usage exceeds this percentage
SWAP_CRIT_PCT=80                     # Critical if swap usage exceeds this percentage

# Service monitoring
# Space-separated list of services to monitor
SERVICES_TO_MONITOR="bitcoind lnd electrs tor"
SERVICE_CHECK_METHOD="systemd"      # systemd or process (systemd preferred if available)

# Temperature monitoring
TEMP_WARN_CELSIUS=70                 # Warn if temperature exceeds this
TEMP_CRIT_CELSIUS=80                 # Critical if temperature exceeds this
TEMP_CHECK_ENABLED=true              # Set to false to disable temperature checks

# Network connectivity monitoring
NETWORK_CHECK_HOSTS="8.8.8.8 1.1.1.1"  # Space-separated IPs to ping
NETWORK_CHECK_DNS="google.com"       # Domain to test DNS resolution
NETWORK_CHECK_TIMEOUT=5              # Timeout for ping/DNS tests (seconds)

# Tor-only mode enforcement (clearnet leak detection)
TOR_ONLY_CHECK_ENABLED=false         # Set to true to enable clearnet leak detection
TOR_SOCKS_PORT=9050                  # Tor SOCKS proxy port (connections to this are OK)
TOR_CONTROL_PORT=9051                # Tor control port (connections to this are OK)
# Processes allowed to make clearnet connections (regex pattern)
TOR_CLEARNET_ALLOWED_PROCESSES="tor|systemd-timesyncd|chronyd|ntpd"
# Optional: Specific IPs allowed (space-separated, for NTP servers, etc.)
TOR_CLEARNET_ALLOWED_IPS=""

# Heartbeat / Daily Summary
HEARTBEAT_INTERVAL="daily"           # daily, weekly, or disabled
HEARTBEAT_INCLUDE_SYSTEM_STATS=true  # Include uptime, load, memory in heartbeat

# Mempool Health Thresholds
# ---------------------------
# Mempool usage (percentage of maxmempool)
MEMPOOL_USAGE_WARN_HIGH=70     # Warn if usage exceeds 70%
MEMPOOL_USAGE_CRIT_HIGH=90     # Critical if usage exceeds 90%

# Mempool size (transaction count)
MEMPOOL_SIZE_WARN_LOW=5        # Warn if mempool has fewer than 5 transactions
MEMPOOL_SIZE_CRIT_LOW=0        # Critical if mempool is completely empty (with unbroadcast > 0)

# Minimum relay fee elevation (multiplier vs. minrelaytxfee)
MEMPOOL_MINFEE_MULTIPLIER_WARN=2.0   # Warn if mempoolminfee is 2x minrelaytxfee
MEMPOOL_MINFEE_MULTIPLIER_CRIT=5.0   # Critical if mempoolminfee is 5x minrelaytxfee

# Unbroadcast transactions (stuck in local mempool)
MEMPOOL_UNBROADCAST_WARN=10    # Warn if 10+ transactions unbroadcast
MEMPOOL_UNBROADCAST_CRIT=50    # Critical if 50+ transactions unbroadcast


##############################
# Behavior / Policy
##############################

# Note: These paths are relative to installation directory
# Adjust if you install node-monitor in a non-standard location
STATE_DIR="/usr/local/node-monitor/state"
CHECKS_DIR="/usr/local/node-monitor/checks.d"

ALERT_ON_WARN=true
ALERT_COOLDOWN_SECONDS=900   # 15 minutes


##############################
# Retry Settings (Tor / Public Checks)
##############################

RETRY_ATTEMPTS=3
RETRY_DELAY_SECONDS=5


############################################################
# Status Export Configuration
############################################################

# Enable or disable exporting a public‑safe status snapshot
EXPORT_STATUS=true

# Directory where export files (status.json) will be written locally
# before being transferred to remote destination
EXPORT_DIR="/usr/local/node-monitor/export"

# Export method:
#   scp   - push to remote host
#   local - write to a local file
#   none  - disable exporting
EXPORT_METHOD="scp"

# Export transport:
#   ssh     - use standard SSH (default for scp)
#   torsocks  - use torsocks for Tor‑based export
EXPORT_TRANSPORT="torsocks"

# Location of torsocks binary (if EXPORT_TRANSPORT="torsocks")
TORSOCKS_BIN="/usr/bin/torsocks"

# For EXPORT_METHOD=scp
# 
# IMPORTANT: if EXPORT_TRANSPORT is "torsocks", ensure that the
# target host is reachable over Tor (e.g., .onion address).
# 
# Examples:
#   EXPORT_SCP_TARGET="user@remote-host:/path/to/status.json"
#   EXPORT_SCP_TARGET="user@abcd1234xyz.onion:/path/to/status.json"
EXPORT_SCP_TARGET="user@remote-host:/path/to/status.json"
EXPORT_SCP_IDENTITY="${HOME}/.ssh/id_ed25519"

# For EXPORT_METHOD=local
EXPORT_LOCAL_TARGET="/var/www/status.json"


##############################
# Public‑Safe Checks
##############################

# Only these checks will appear in the public export.
# All other checks remain private.
# System checks (400+) and heartbeat (460) are typically kept private.
PUBLIC_CHECKS=(
  # Bitcoin Core
  "010-bitcoin-rpc"
  "020-bitcoin-sync-status"
  "030-bitcoin-blockheight"
  "040-bitcoin-block-age"
  
  # Bitcoin Mempool
  "050-bitcoin-mempool-usage"
  "060-bitcoin-mempool-size"
  "070-bitcoin-mempool-minfee"
  "080-bitcoin-mempool-unbroadcast"
  
  # LND
  "100-lnd-wallet"
  "110-lnd-peers"
  "120-lnd-channels"
  "130-lnd-blockheight"
  "140-lnd-chain-sync"
  "150-lnd-graph-sync"
  
  # Tor
  "200-tor-socks"
  "210-tor-circuit"
  "220-tor-onion"
  
  # Electrs
  "300-electrs-connectivity"
  "310-electrs-sync"
  "320-electrs-performance"
)


############################################################
# Nodecard Export Configuration
############################################################

# Enable or disable exporting a signed nodecard with node information
# (alias, color, URIs, channels, fee policies, etc.)
# This is typically run on a daily schedule, separate from run-checks.sh
NODECARD_EXPORT_ENABLED=false

# Export method:
#   scp   - push to remote host
#   local - write to a local file
#   none  - disable uploading (still creates local nodecard.json)
NODECARD_EXPORT_METHOD="scp"

# Export transport:
#   ssh       - use standard SSH (default for scp)
#   torsocks  - use torsocks for Tor‑based export
NODECARD_EXPORT_TRANSPORT="torsocks"

# For NODECARD_EXPORT_METHOD=scp
# 
# IMPORTANT: if NODECARD_EXPORT_TRANSPORT is "torsocks", ensure that the
# target host is reachable over Tor (e.g., .onion address).
# 
# Examples:
#   NODECARD_EXPORT_SCP_TARGET="user@remote-host:/path/to/nodecard.json"
#   NODECARD_EXPORT_SCP_TARGET="user@abcd1234xyz.onion:/path/to/nodecard.json"
NODECARD_EXPORT_SCP_TARGET="user@remote-host:/path/to/nodecard.json"
NODECARD_EXPORT_SCP_IDENTITY="${HOME}/.ssh/id_ed25519"

# For NODECARD_EXPORT_METHOD=local
NODECARD_EXPORT_LOCAL_TARGET="/path/to/nodecard.json"

##############################
# History Configuration
##############################

# Number of recent check results to retain in rolling history
# This creates a time-series view of recent check status changes
# Examples:
#   12  = last 12 checks (1 hour at 5-minute intervals)
#   24  = last 24 checks (2 hours at 5-minute intervals) [default]
#   48  = last 48 checks (4 hours at 5-minute intervals)
#   288 = last 288 checks (24 hours at 5-minute intervals)
HISTORY_SLOTS=24

# Include history in exported status.json
# When true, the exported status.json will contain a "history" array
# for each check showing recent status changes
EXPORT_HISTORY=true