#!/bin/bash
# Node Monitor Deployment Script
# This script deploys the node-monitor scripts to a system directory

set -e  # Exit on error

# Configuration
INSTALL_DIR="${INSTALL_DIR:-/usr/local/node-monitor}"
OWNER="${OWNER:-root}"
GROUP="${GROUP:-root}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if running as root
if [ "$EUID" -ne 0 ]; then 
    log_error "This script must be run as root (use sudo)"
    exit 1
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

log_info "Starting deployment to ${INSTALL_DIR}"
log_info "Owner will be set to ${OWNER}:${GROUP}"

# Create installation directory if it doesn't exist
if [ ! -d "$INSTALL_DIR" ]; then
    log_info "Creating installation directory: ${INSTALL_DIR}"
    mkdir -p "$INSTALL_DIR"
else
    log_warn "Installation directory already exists: ${INSTALL_DIR}"
fi

# Create checks.d directory
log_info "Creating checks.d directory"
mkdir -p "${INSTALL_DIR}/checks.d"

# Create local.d directory (for custom checks)
log_info "Creating local.d directory for custom checks"
mkdir -p "${INSTALL_DIR}/local.d"

# Create state directory (for runtime state files)
log_info "Creating state directory"
mkdir -p "${INSTALL_DIR}/state"

# Copy main scripts
log_info "Copying main scripts"
for script in export-nodecard.sh export-status.sh run-checks.sh send-email.sh send-ntfy.sh send-signal.sh test-config.sh; do
    if [ -f "${SCRIPT_DIR}/${script}" ]; then
        cp "${SCRIPT_DIR}/${script}" "${INSTALL_DIR}/"
        log_info "  Copied ${script}"
    else
        log_warn "  Skipping ${script} (not found)"
    fi
done

# Copy helper scripts
log_info "Copying helper scripts"
if [ -f "${SCRIPT_DIR}/helpers.sh" ]; then
    cp "${SCRIPT_DIR}/helpers.sh" "${INSTALL_DIR}/"
    log_info "  Copied helpers.sh"
fi

# Copy configuration example
log_info "Copying configuration files"
if [ -f "${SCRIPT_DIR}/config.sh.example" ]; then
    cp "${SCRIPT_DIR}/config.sh.example" "${INSTALL_DIR}/"
    log_info "  Copied config.sh.example"
fi

# Check if config.sh already exists (don't overwrite)
if [ -f "${INSTALL_DIR}/config.sh" ]; then
    log_warn "  config.sh already exists, not overwriting"
elif [ -f "${SCRIPT_DIR}/config.sh" ]; then
    cp "${SCRIPT_DIR}/config.sh" "${INSTALL_DIR}/"
    log_info "  Copied config.sh"
fi

# Copy check scripts
log_info "Copying check scripts"
if [ -d "${SCRIPT_DIR}/checks.d" ]; then
    for check in "${SCRIPT_DIR}"/checks.d/*.sh; do
        if [ -f "$check" ]; then
            cp "$check" "${INSTALL_DIR}/checks.d/"
            log_info "  Copied $(basename "$check")"
        fi
    done
fi

# Copy documentation
log_info "Copying documentation"
for doc in README.md LICENSE; do
    if [ -f "${SCRIPT_DIR}/${doc}" ]; then
        cp "${SCRIPT_DIR}/${doc}" "${INSTALL_DIR}/"
        log_info "  Copied ${doc}"
    fi
done

# Copy checks.d README if it exists
if [ -f "${SCRIPT_DIR}/checks.d/README.md" ]; then
    cp "${SCRIPT_DIR}/checks.d/README.md" "${INSTALL_DIR}/checks.d/"
    log_info "  Copied checks.d/README.md"
fi

# Copy local.d README (but not custom check scripts - those are site-specific)
if [ -f "${SCRIPT_DIR}/local.d/README.md" ]; then
    cp "${SCRIPT_DIR}/local.d/README.md" "${INSTALL_DIR}/local.d/"
    log_info "  Copied local.d/README.md"
fi

# Set permissions
log_info "Setting permissions"

# Directories: 755 (rwxr-xr-x) - everyone can read and execute
find "${INSTALL_DIR}" -type d -exec chmod 755 {} \;
log_info "  Set directory permissions to 755"

# Shell scripts: 755 (rwxr-xr-x) - everyone can read and execute
find "${INSTALL_DIR}" -type f -name "*.sh" -exec chmod 755 {} \;
log_info "  Set script permissions to 755"

# Other files: 644 (rw-r--r--) - everyone can read
find "${INSTALL_DIR}" -type f ! -name "*.sh" -exec chmod 644 {} \;
log_info "  Set file permissions to 644"

# State directory: 755, but owner should have write access
chmod 755 "${INSTALL_DIR}/state"
log_info "  Set state directory permissions to 755"

# Set ownership
log_info "Setting ownership to ${OWNER}:${GROUP}"
chown -R "${OWNER}:${GROUP}" "${INSTALL_DIR}"

# Final status
log_info "Deployment complete!"
echo ""
log_info "Next steps:"
echo "  1. Edit ${INSTALL_DIR}/config.sh (or copy from config.sh.example)"
echo "  2. Configure your notification methods and check parameters"
echo "  3. Test the configuration: ${INSTALL_DIR}/test-config.sh"
echo "  4. Run checks manually: ${INSTALL_DIR}/run-checks.sh"
echo "  5. (Optional) Add custom checks to ${INSTALL_DIR}/local.d/ (use 500+ numbering)"
echo "  6. Set up a cron job to run checks periodically"
echo ""
log_info "Example cron entry (run every 5 minutes):"
echo "  */5 * * * * ${INSTALL_DIR}/run-checks.sh"
echo ""
